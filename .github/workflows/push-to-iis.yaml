name: Push to IIS Server

on:
  push:
    branches:
      - main
  workflow_dispatch:


jobs:
  #  build:
  #    name: Build for PR
  #    uses: ./.github/workflows/build-app.yaml
  #    with:
  #      artifact_name: 'iis-site'

  build-and-deploy:
    runs-on: iis
    #    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          static_site_generator: next

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          # Generate a new cache whenever adoption or source files change.
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          # If source files changed but adoption didn't, rebuild from a prior cache.
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}-

      - name: Install dependencies
        run: npm ci

      - name: Build with Next.js
        id: build
        run: |
          set -o pipefail
          npx next build 2>build-errors.txt || (
            echo "## ❌ Build failed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat build-errors.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          )

      #      - name: Stop IIS
      #        run: Stop-IISSite -Name "terra-stack-docs"
      #        shell: powershell

      - name: Move application files
        run: |
          Copy-Item -Path "./node-modules" -Destination "C:/inetpub/TerraMagma/TerraStack/docs/" -Recurse -Force
          Copy-Item -Path "./.next" -Destination "C:/inetpub/TerraMagma/TerraStack/docs/" -Recurse -Force
          Copy-Item -Path "./server.js" -Destination "C:/inetpub/TerraMagma/TerraStack/docs/" -Recurse -Force
          Copy-Item -Path "./web.config" -Destination "C:/inetpub/TerraMagma/TerraStack/docs/" -Recurse -Force
        shell: powershell

#      - name: Start IIS
#        run: Start-IISSite -Name "TerraStack-docs"
#        shell: powershell